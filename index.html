<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <style>
        .col-xs-6,.col-sm-2,.col-xs-12,.col-sm-4{
            padding-left: 30px;
        }
        .container{
            padding: 10px;
            background: #eee;
        }
        .row{
            padding:10px;
            margin: 0 30px;
        }
        .row p{
            padding-left: 20px;
        }
        h4{
            padding: 10px 10px;
        }
        label{
            font-weight: lighter;
        }
        #pageNum{
            padding: 10px;
            text-align: center;
        }
        .choose p{
            color:#f00;
        }
    </style>
</head>
<body>
<!--<div class="container" id="app">
    <h2 style="text-align: center">2017年湖北省国税局纳税人满意度专项调查问卷</h2>
    <form @submit.prevent="submit">
        <div>
            <h4>{{obj[0].groupTitle}}</h4>
            <div v-for="(pro,k) in obj[0].problemList"  v-if="isShow[k]===0?true:false" v-bind:class="{notice:isChecked}">
                <p>{{pro.problemInfoTitle}}</p>
                <div class="container">
                    <div v-for="an in pro.answerOption" v-bind:class="[cls.c1,cls.c2]">
                        <label>
                            <input v-on:change="getMsg(k,pro.problemInfoID,an.id)"  v-bind:type="pro.proType===0?'radio':'checkbox'" v-bind:name="pro.problemInfoID" v-bind:value="an.id">
                            {{an.content}}
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <input type="submit" value="提交">
    </form>
    <div id="pageNum"><button  id="preItem" v-on:click="pre()">上一题</button>第 <span>{{pageN+1}}</span>/{{pageEnd+1}}<button id="nextItem" v-on:click="next()">下一题</button></div>
</div>-->
<div class="container" id="app">
    <h2 style="text-align: center">2017年湖北省国税局纳税人满意度专项调查问卷</h2>
    <form @submit.prevent="submit">
        <div>
            <h4>{{obj[pageN].groupTitle}}</h4>
            <div v-for="(pro,k) in obj[pageN].problemList"  v-if="pro.isShow===0?true:false" v-bind:class="{choose:pro.unChoose}">
                <p>{{pro.problemInfoTitle}}</p>
                <div class="container">
                    <div v-for="(an,i) in pro.answerOption" v-bind:class="{'col-xs-6':pro.proType===0,'col-sm-2':pro.proType===0}">
                        <label>
                            <input :checked="an.isChecked"  v-on:change="getMsg(pageN,k,pro.problemInfoID,an.id,i)"  v-bind:type="pro.proType===0?'radio':'checkbox'" v-bind:name="pro.problemInfoID" v-bind:value="an.id">
                            {{an.content}}
                        </label>
                    </div>
                </div>
            </div>
        </div>
        {{msg.model}}
        <input v-if="subButton" type="submit" value="提交">
    </form>
    <div id="pageNum"><button  id="preItem" v-on:click="pre()">上一题</button>第 <span>{{pageN+1}}</span>/{{pageEnd+1}}<button id="nextItem" v-on:click="next()">下一题</button></div>
</div>
<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/vue.js"></script>
<script type="text/javascript" src="js/vue-resource.js"></script>
<script>

    var app1=new Vue({
        el:"#app",
        data:{
            pageN:0,//记录题组及页面
            pageEnd:9,//最后一题题组
            subButton:false,
            obj:[],//测试题内容
            msg:{//提交的数据
                model: [//盛放题组的容器
                ],
                sourceType:"",
                sourceDetail: "",
                taxAuthCode: ""
            }
        },
        mounted:function(){
                this.add(0);//加载第一页面
        },
        methods:{
            pre:function(){//向前翻页
                this.pageN--;
                this.pageN=this.pageN<0?0:this.pageN;
                this.add(this.pageN)
            },
            next:function(){//向后翻页
                this.pageN++;
                this.pageN=this.pageN>this.pageEnd?this.pageEnd:this.pageN;
                this.add(this.pageN)
            },
            add:function(groupId){//页面渲染
                var url="http://hbgs12366.dfinfo.cn/api/Values/GetAnswerByID";
                if(this.obj.length<=this.pageN) {
                    this.$http.post(url, {groupID: groupId}).then(function (data) {
                        Vue.set(this.obj, groupId, data.body);//把请求数据存储本地
                        this.obj[groupId].problemList.forEach(function(v,k){
                            v.answerOption.forEach(function(v1,k1){
                                Vue.set(v1,'isChecked',false);
                            })
                        })
                        console.log(this.obj);
                    },function(response){
                        console.log(response+"请求错误");
                    })
                }
                //控制提交按钮显示隐藏
                if(this.pageN===this.pageEnd){
                    this.subButton=true;
                }else{
                    this.subButton=false;
                }
            },
            getMsg:function(pageN,key,name,val,index){
                //pageN组 key题 name名称 val值 index选项
                //更改选择状态
                if(this.obj[pageN].problemList[key].proType===0){//单选
                    this.obj[pageN].problemList[key].answerOption.forEach(function(v,k){
                        v.isChecked=false;
                    });
                    this.obj[pageN].problemList[key].answerOption[index].isChecked=true;
                }else if(this.obj[pageN].problemList[key].proType===1){//多选
                    this.obj[pageN].problemList[key].answerOption[index].isChecked=!this.obj[pageN].problemList[key].answerOption[index].isChecked;
                }
                //答题的跳转逻辑
                var that=this;
                var ruleList=this.obj[pageN].ruleList;
                console.log(pageN+";"+key+";"+name+";"+val+";"+index);
                if(ruleList.length!==0){
                    for(var i=0;i<ruleList.length;i++){
                        var targetProblemInfoID=parseInt(ruleList[i].problemInfoID);//匹配问题id
                        var redirectID=parseInt(ruleList[i].redirectID);//跳转问题id
                        var answerOptionInfoNo=parseInt(ruleList[i].answerOptionInfoNo);//答案
                        var sortIndex=parseInt(ruleList[i].sortIndex);//排序优先级
                        //和当前题组做比对
                        //第一种类型的跳转 单选本页跳转
                        if(parseInt(ruleList[i].redirectType)===0){
                            if(targetProblemInfoID===name){
                                for(var j=0;j<that.obj[pageN].problemList.length;j++){
                                    if(that.obj[pageN].problemList[j].problemInfoID===redirectID){
                                        if(answerOptionInfoNo===val){
                                            that.obj[pageN].problemList[j].isShow=0;
                                            return;
                                        }else{
                                            that.obj[pageN].problemList[j].isShow=1;
                                        }
                                    }
                                }
                            }
                        };
                        //第二种类型的跳转 多选它页跳转
                        if(parseInt(ruleList[i].redirectType)===1){
                            if(targetProblemInfoID===name){
                                var mulAns;
                                for(var m=0;m<that.obj[pageN].problemList.length;m++){
                                    if(that.obj[pageN].problemList[m].problemInfoID===targetProblemInfoID){
                                        for(var n=0;n<that.obj[pageN].problemList[m].answerOption.length;n++){
                                            if(that.obj[pageN].problemList[m].answerOption[n].isChecked===true){
                                                mulAns=that.obj[pageN].problemList[m].answerOption[n].id;
                                            }
                                        };
                                    }
                                };
                               /* if(mulAns===4){
                                    this.pageN=7
                                }*/
                            }
                        }
                    }
                }

            },
            submit:function(){
                //将obj内的数据添加给提交数组msg
                this.msg.model=[];
                var arr=[];
                var that=this;
                this.obj.forEach(function(v,k){
                    arr[k]=[];//一个题组
                    v.problemList.forEach(function(v1,k1){
                        arr[k][k1]={};//一个小题
                        arr[k][k1].problemID=v1.problemInfoID;//小题的编号 唯一
                        if(v1.proType===0){//单选
                            v1.answerOption.forEach(function(v2,k2){
                                if(v2.isChecked){
                                    arr[k][k1].answerID=v2.id;
                                }
                            })
                        }else if(v1.proType===1){//多选
                            arr[k][k1].answerID=[]
                            v1.answerOption.forEach(function(v2,k2){
                                if(v2.isChecked){
                                    arr[k][k1].answerID.push(v2.id);
                                }
                            })
                        }
                        //添加选择状态（是否选择）
                        if(typeof arr[k][k1].answerID==="undefined"){//单选未选择
                                Vue.set(v1,"unChoose",true)
                        }else if(typeof arr[k][k1].answerID==="object"){//多选
                            if(arr[k][k1].answerID.length===0){//未选择
                                Vue.set(v1,"unChoose",true)
                            }else {
                                Vue.set(v1, "unChoose", false)//选择
                            }
                        }else{//单选选择
                            Vue.set(v1,"unChoose",false)
                        }
                    });
                    that.msg.model=that.msg.model.concat(arr[k])
                });
                //提交答题
                var url="#";
                if(this.checkedSubmit()){
                    this.$http.post(url,this.msg).then(function(data){
                        //console.log(data)
                    })
                }else{
                    alert("未完成答题")
                }
            },
            checkedSubmit:function(){
                for(var i=0;i<this.obj.length;i++){
                    for(var j=0;j<this.obj[i].problemList.length;j++){
                        if(this.obj[i].problemList[j].unChoose===true){
                            return false;
                        }
                    }
                }
                return true;
            }
        }
    });

</script>
</body>
</html>